<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Juice AR Demo (Animated JS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body style="margin:0; font-family: sans-serif;">

  <h2 style="text-align:center; margin:10px 0;">üçπ Juice AR Demo ‚Äî Animated</h2>

  <!-- small UI to toggle spin (works on mobile) -->
  <button id="spinBtn" style="position:fixed; left:12px; bottom:18px; z-index:9999; padding:8px 12px;">
    Toggle Spin
  </button>

  <a-scene id="scene"
           mindar-image="imageTargetSrc: juice.mind;"
           color-space="sRGB"
           renderer="colorManagement: true, physicallyCorrectLights"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false">

    <a-assets>
      <!-- Put juice.glb in same folder -->
      <a-asset-item id="juiceModel" src="juice.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- simple lighting -->
    <a-light type="ambient" intensity="0.9"></a-light>
    <a-light type="directional" intensity="0.8" position="1 1 0.5"></a-light>

    <!-- container is anchored to the marker; invisible by default -->
    <a-entity id="juiceContainer" mindar-image-target="targetIndex: 0" visible="false">
      <!-- model starts at scale 0 so we'll scale it in -->
      <a-gltf-model id="juiceObject"
                    src="#juiceModel"
                    scale="0 0 0"
                    position="0 0 0"
                    rotation="0 0 0"
                    animation-mixer>
      </a-gltf-model>
    </a-entity>

  </a-scene>

  <script>
    // Elements
    const scene = document.querySelector("#scene");
    const container = document.querySelector("#juiceContainer");
    const model = document.querySelector("#juiceObject");
    const spinBtn = document.querySelector("#spinBtn");

    // Animation state and params (tweak these)
    let animRunning = false;
    let spinning = true;
    let rotationY = 0;            // current Y rotation (degrees)
    let baseY = 0;                // base Y position for floating
    const floatAmp = 0.05;       // float amplitude (meters)
    const floatFreq = 0.5;       // float frequency (Hz)
    const spinPeriod = 8000;     // ms per full spin
    const scaleTarget = 0.5;     // final scale (adjust to fit your model)
    const scaleDuration = 600;   // ms for scale-in
    let scaling = false;
    let scaleStart = 0;
    let scaleStartTime = 0;
    let prevTime = null;

    // Wait for GLB to load so we can read its position (pivot)
    model.addEventListener("model-loaded", () => {
      const pos = model.getAttribute("position");
      baseY = (pos && pos.y) ? pos.y : 0;
      console.log("model-loaded, baseY =", baseY);
    });

    // MindAR events
    scene.addEventListener("loaded", () => {
      const mindar = scene.components["mindar-image"];
      if (!mindar) {
        console.error("mindar-image component not found");
        return;
      }

      mindar.el.addEventListener("targetFound", () => {
        console.log("‚úÖ Marker found ‚Äî starting animations");
        container.setAttribute("visible", "true");
        model.setAttribute("visible", "true");

        // initialize scale animation
        const s = model.getAttribute("scale");
        scaleStart = (s && s.x) ? s.x : 0;
        scaling = true;
        scaleStartTime = performance.now();

        // start loop if not already running
        if (!animRunning) {
          animRunning = true;
          prevTime = null;
          requestAnimationFrame(loop);
        }
      });

      mindar.el.addEventListener("targetLost", () => {
        console.log("‚ùå Marker lost ‚Äî stopping animations & resetting");
        container.setAttribute("visible", "false");
        model.setAttribute("visible", "false");

        // reset state
        scaling = false;
        animRunning = false;
        rotationY = 0;
        model.setAttribute("rotation", `0 0 0`);
        model.setAttribute("scale", `0 0 0`);
        model.setAttribute("position", `0 ${baseY} 0`);
      });
    });

    // Main animation loop (requestAnimationFrame)
    function loop(now) {
      if (!animRunning) return;      // stop loop when not running
      if (!prevTime) prevTime = now;
      const dt = now - prevTime;     // ms since last frame
      prevTime = now;

      // scaling (smooth ease-out)
      if (scaling) {
        const elapsed = now - scaleStartTime;
        const t = Math.min(1, elapsed / scaleDuration);
        const eased = easeOutCubic(t);
        const s = scaleStart + (scaleTarget - scaleStart) * eased;
        model.setAttribute("scale", `${s} ${s} ${s}`);
        if (t >= 1) scaling = false;
      }

      // spinning
      if (spinning) {
        rotationY = (rotationY + dt * 360 / spinPeriod) % 360;
        model.setAttribute("rotation", `0 ${rotationY} 0`);
      }

      // floating (sinusoidal)
      const floatY = baseY + Math.sin(now / 1000 * Math.PI * 2 * floatFreq) * floatAmp;
      model.setAttribute("position", `0 ${floatY} 0`);

      requestAnimationFrame(loop);
    }

    // Simple easing
    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

    // Toggle spin from UI button (works on mobile)
    spinBtn.addEventListener("click", (e) => {
      spinning = !spinning;
      spinBtn.textContent = spinning ? "Toggle Spin" : "Start Spin";
      console.log("Spin toggled:", spinning);
    });

    // Also allow clicking/tapping the model to toggle spin (if device sends event to model)
    model.addEventListener("click", () => {
      spinning = !spinning;
      console.log("Spin toggled (model click):", spinning);
    });

    // Helpful debug hints in console
    console.log("Debug: ready ‚Äî look for 'model-loaded', 'Marker found', and 'Marker lost' in console.");
  </script>
</body>
</html>
