<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Juice AR Demo (GLTF + Animations)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body style="margin:0; font-family: sans-serif;">

  <h2 style="text-align:center; margin:10px 0;">üçπ Juice AR Demo ‚Äî Colorful GLTF</h2>

  <!-- Toggle Spin Button -->
  <button id="spinBtn" style="position:fixed; left:12px; bottom:18px; z-index:9999; padding:8px 12px;">
    Toggle Spin
  </button>

  <a-scene id="scene"
           mindar-image="imageTargetSrc: juice.mind;"
           color-space="sRGB"
           renderer="colorManagement: true, physicallyCorrectLights, exposure:1.2, toneMapping:ACESFilmic"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false">

    <a-assets>
      <!-- Load GLTF model (with textures in /textures folder) -->
      <a-asset-item id="juiceModel" src="juice.gltf"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Better Lighting -->
    <a-light type="hemisphere" intensity="1" color="#ffffff" ground-color="#444444"></a-light>
    <a-light type="directional" intensity="1" position="2 4 5"></a-light>
    <a-light type="point" intensity="0.6" position="-2 2 2" color="#ffdca8"></a-light>

    <!-- Container bound to marker -->
    <a-entity id="juiceContainer" mindar-image-target="targetIndex: 0" visible="false">
      <a-gltf-model id="juiceObject"
                    src="#juiceModel"
                    scale="0 0 0"
                    position="0 0 0"
                    rotation="0 0 0"
                    animation-mixer>
      </a-gltf-model>
    </a-entity>

  </a-scene>

  <script>
    const scene = document.querySelector("#scene");
    const container = document.querySelector("#juiceContainer");
    const model = document.querySelector("#juiceObject");
    const spinBtn = document.querySelector("#spinBtn");

    let animRunning = false;
    let spinning = true;
    let rotationY = 0;
    let baseY = 0;
    const floatAmp = 0.05;
    const floatFreq = 0.5;
    const spinPeriod = 8000;
    const scaleTarget = 0.5;
    const scaleDuration = 600;
    let scaling = false;
    let scaleStart = 0;
    let scaleStartTime = 0;
    let prevTime = null;

    model.addEventListener("model-loaded", () => {
      const pos = model.getAttribute("position");
      baseY = (pos && pos.y) ? pos.y : 0;
      console.log("‚úÖ model-loaded with textures, baseY =", baseY);
    });

    scene.addEventListener("loaded", () => {
      const mindar = scene.components["mindar-image"];
      if (!mindar) {
        console.error("mindar-image component not found");
        return;
      }

      mindar.el.addEventListener("targetFound", () => {
        console.log("‚úÖ Marker found ‚Äî starting animations");
        container.setAttribute("visible", "true");
        model.setAttribute("visible", "true");

        const s = model.getAttribute("scale");
        scaleStart = (s && s.x) ? s.x : 0;
        scaling = true;
        scaleStartTime = performance.now();

        if (!animRunning) {
          animRunning = true;
          prevTime = null;
          requestAnimationFrame(loop);
        }
      });

      mindar.el.addEventListener("targetLost", () => {
        console.log("‚ùå Marker lost ‚Äî hiding model");
        container.setAttribute("visible", "false");
        model.setAttribute("visible", "false");

        scaling = false;
        animRunning = false;
        rotationY = 0;
        model.setAttribute("rotation", `0 0 0`);
        model.setAttribute("scale", `0 0 0`);
        model.setAttribute("position", `0 ${baseY} 0`);
      });
    });

    function loop(now) {
      if (!animRunning) return;
      if (!prevTime) prevTime = now;
      const dt = now - prevTime;
      prevTime = now;

      if (scaling) {
        const elapsed = now - scaleStartTime;
        const t = Math.min(1, elapsed / scaleDuration);
        const eased = easeOutCubic(t);
        const s = scaleStart + (scaleTarget - scaleStart) * eased;
        model.setAttribute("scale", `${s} ${s} ${s}`);
        if (t >= 1) scaling = false;
      }

      if (spinning) {
        rotationY = (rotationY + dt * 360 / spinPeriod) % 360;
        model.setAttribute("rotation", `0 ${rotationY} 0`);
      }

      const floatY = baseY + Math.sin(now / 1000 * Math.PI * 2 * floatFreq) * floatAmp;
      model.setAttribute("position", `0 ${floatY} 0`);

      requestAnimationFrame(loop);
    }

    function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

    spinBtn.addEventListener("click", () => {
      spinning = !spinning;
      spinBtn.textContent = spinning ? "Toggle Spin" : "Start Spin";
      console.log("üîÑ Spin toggled:", spinning);
    });

    model.addEventListener("click", () => {
      spinning = !spinning;
      console.log("üîÑ Spin toggled (model click):", spinning);
    });
  </script>
</body>
</html>
